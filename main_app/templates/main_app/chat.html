{% extends "main_app/base.html" %}
{% load static %}
{% block title %}chat{% endblock title %}
{% block name %}chat_w{% endblock name %}
{% block css %}
        <!-- <link rel="stylesheet" href="{% static 'css/edit_quiz.css' %}"> -->
    <style>
    #chatBox {
    transition: opacity 0.3s ease;
    opacity: 0;
    }
    #chatBox.show {
    opacity: 1;
    }
    </style>
{% endblock css %}


{% block content %}
<button id="chatToggle" class="btn btn-primary">Чат</button>

<!-- Чат-бокс -->
<div id="chatBox" class="card shadow" style="display: none; position: absolute; bottom: 70px; right: 20px; width: 300px; z-index: 1050;">
  <div class="card-header bg-dark text-white">
    Чат
  </div>
  <div class="card-body" style="height: 300px; overflow-y: auto;">
    <div id="chatMessages">
      <p>Добро пожаловать!</p>
    </div>
  </div>
  <div class="card-footer p-2">
    <input type="text" class="form-control" placeholder="Введите сообщение...">
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
  // Получить CSRF-токен из <input type="hidden">
  function getCSRFToken() {
    return document.querySelector("[name=csrfmiddlewaretoken]").value;
  }

  // DOM элементы
  const chatModalEl = document.getElementById("chatModal");
  const chatBox = document.getElementById("chatBox");
  const chatMessages = document.getElementById("chatMessages");
  const chatInput = document.getElementById("chatInput");
  const sendChatBtn = document.getElementById("sendChatBtn");
  const chatToggle = document.getElementById("chatToggle");

  // При открытии модалки — фокус на инпут
  chatModalEl.addEventListener("shown.bs.modal", () => {
    chatInput.focus();
  });

  // При клике по кнопке в контенте — показать/скрыть чат-бокс
  chatToggle.addEventListener("click", () => {
    const isHidden = chatBox.style.display === "none" || chatBox.style.display === "";
    chatBox.style.display = isHidden ? "block" : "none";
  });

  // Обработка кнопки "Отправить"
  sendChatBtn.addEventListener("click", () => {
    const message = chatInput.value.trim();
    if (!message) return;

    fetch("/chat/chat/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken(),
      },
      body: JSON.stringify({ message }),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Ошибка при отправке");
        return res.json();
      })
      .then((data) => {
        // Закрыть модалку
        const modal = bootstrap.Modal.getInstance(chatModalEl);
        modal.hide();

        // Показать чат-бокс
        chatBox.style.display = "block";

        // Вставить сообщение
        const msgElem = document.createElement("p");
        msgElem.innerText = data.message || message;
        chatMessages.appendChild(msgElem);

        // Очистить поле
        chatInput.value = "";
      })
      .catch((err) => {
        console.error("Ошибка отправки:", err);
      });
  });
</script>
{% endblock scripts %}


