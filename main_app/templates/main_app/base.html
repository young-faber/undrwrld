{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% block css %}{% endblock css %}

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      integrity="sha384-tViUnnbYAV00FLIhhi3v/dWt3Jxw4gZQcNoSCxCIFNJVCx7/D55/wXsrNIRANwdD"
      crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <title>{% block title %}{% endblock title %}</title>

    <style>
      .dark-input {
        background-color: #000;
        color: #9d4d4d;
        border: 1px solid #824747;
      }
      .dark-input::placeholder {
        color: #ffffff;
        opacity: 1;
      }
      footer {
        flex-shrink: 0;
        background-color: #000;
        color: #fff;
        padding: 1rem;
        text-align: center;
      }
      header {
      background-color: #000;
      color: #fff;
      padding: 1rem 0;
      }
    </style>
  </head>

  <body class="d-flex flex-column min-vh-100">
    <header>
      <div class="container d-flex justify-content-between align-items-center">
        <h1 class="h5 m-0">{% block name %}{% endblock name %}</h1>
        <div class="d-flex align-items-center gap-1">
          <!-- Кнопка, открывающая модалку -->
          <div id="chatWrapper">
            <span
              id="chatBtn"
              class="btn btn-outline-light btn-sm"
              style="cursor: pointer"
              data-bs-toggle="modal"
              data-bs-target="#chatModal"
              >chat</span
            >
            {% csrf_token %}
          </div>

          <a href="/" class="btn btn-outline-light btn-sm">Главное меню</a>
        </div>
      </div>
    </header>

    <main class="container-fluid main-container px-5 flex-grow-1">
      {% block content %}{% endblock content %}
    </main>

   

    <footer>
      www - wrld win web | 
      
      {% if request.resolver_match.url_name == "quiz/" %}
    <a href="/">Lobby</a>
    {% else %}
    <a href="/quiz/">All quizes</a>
    {% endif %}
    </footer>

    <!-- Модальное окно чата -->
    <div
      class="modal fade"
      id="chatModal"
      tabindex="-1"
      aria-labelledby="chatModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="chatModalLabel">Чат</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Закрыть"
            ></button>
          </div>
          <div class="modal-body">
            <div class="messages-list"></div>
            <input
              type="text"
              id="chatInput"
              class="form-control form-control-sm dark-input"
              placeholder="Введите сообщение..."
            />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary btn-sm"
              data-bs-dismiss="modal"
            >
              Закрыть
            </button>
            <button
              type="button"
              class="btn btn-primary btn-sm"
              id="sendChatBtn"
            >
              Отправить
            </button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

    <script>
      // Берём CSRF из встроенного тега
      function getCSRFToken() {
        return document.querySelector("[name=csrfmiddlewaretoken]").value;
      }

      // При открытии модального окна ставим фокус в input
      const chatModalEl = document.getElementById("chatModal");
      chatModalEl.addEventListener("shown.bs.modal", () => {
        fetch("/chat/message_list", { method: "GET" })
          .then((res) => {
            return res.json();
          })
          .then((data) => {
            console.log(data.messages);
            const message_div = document.querySelector(".messages-list");
            for (let msg of data.messages){
              const message = document.createElement('div')
              message.textContent = `${msg.user}\n${msg.text}`
              message_div.append(message)
              console.log(msg)
            }
          });
        document.getElementById("chatInput").focus();
      });

      // Обработка кнопки "Отправить"
      document.getElementById("sendChatBtn").addEventListener("click", () => {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();
        if (!message) return;

        fetch("/chat/chat/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify({ message }),
        })
          .then((res) => {
            console.log(res.ok ? "Отправлено!" : "Ошибка при отправке!");
            // Закрыть модалку при успешной отправке
            if (res.ok) {
              const modal = bootstrap.Modal.getInstance(chatModalEl);
              modal.hide();

              // показать чат-бокс
              document.getElementById("chatBox").style.display = "block";

              // опционально: вставить сообщение в чат сразу
              const chatMessages = document.getElementById("chatMessages");
              const msg = document.createElement("p");
              msg.innerText = message;
              chatMessages.appendChild(msg);
            }
          })
          .catch(console.error);
      });
    </script>

    {% block scripts %}{% endblock scripts %}
  </body>
</html>
 